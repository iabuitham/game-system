<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Operator — Game Control</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/gsap@3.12.2/dist/gsap.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" href="/operator.css" />
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-800 to-pink-700 min-h-screen text-white">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-3xl font-extrabold tracking-tight">Game Control</h1>
        <p class="text-sm opacity-80">Operator dashboard </p>
      </div>
      <div class="flex items-center gap-3">
        <div id="statusBadge" class="px-4 py-2 rounded-md bg-gray-800 text-sm">Not logged</div>
        <button id="logoutBtn" class="px-4 py-2 rounded-md bg-red-600 hover:bg-red-700 text-white font-medium transition-colors duration-200 hidden" title="Logout">
          <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
          Logout
        </button>
      </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <section class="col-span-1 md:col-span-1 bg-white/5 p-4 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold mb-3">Login</h2>
        <div id="loginCard" class="space-y-3">
          <input id="deviceId" class="w-full p-3 rounded-md bg-white/5 border border-white/10" placeholder="Device ID (e.g. OP-1)">
          <input id="deviceSecret" type="password" class="w-full p-3 rounded-md bg-white/5 border border-white/10" placeholder="Device Secret">
          <button id="loginBtn" class="w-full py-3 rounded-md bg-emerald-500 hover:bg-emerald-600 text-black font-bold">Log in</button>
          <div id="loginError" class="text-red-300 text-sm"></div>
        </div>

        <div id="controls" class="mt-6 hidden">
          <h3 class="font-semibold mb-2">Game Controls</h3>
          <div class="space-y-3">
            <button id="startBtn" class="w-full py-3 rounded-md bg-yellow-400 text-black font-bold transform hover:scale-105">Start Game</button>
            <button id="finishBtn" class="w-full py-3 rounded-md bg-gray-600 text-white font-bold" disabled>Finish Round</button>
          </div>
          
          <h3 class="font-semibold mb-2 mt-6">Media Controls</h3>
          <div class="space-y-3">
            <button id="showPricingBtn" class="w-full py-3 rounded-md bg-blue-500 hover:bg-blue-600 text-white font-bold">Show Pricing Sheet</button>
            <button id="hidePricingBtn" class="w-full py-3 rounded-md bg-gray-500 hover:bg-gray-600 text-white font-bold">Hide Pricing Sheet</button>
          </div>

          <div class="mt-6 p-4 bg-white/5 rounded-lg border border-white/10">
            <h4 class="font-medium mb-2 text-sm opacity-80">Session Info</h4>
            <div id="sessionInfo" class="text-xs space-y-1">
              <div>Device: <span id="deviceName" class="font-mono">-</span></div>
              <div>Game: <span id="gameName" class="font-mono">-</span></div>
              <div>Connected: <span id="connectionTime" class="font-mono">-</span></div>
            </div>
          </div>
        </div>
      </section>

      <section class="col-span-1 md:col-span-2 bg-white/5 p-4 rounded-xl shadow-lg">
        <h2 class="text-xl font-semibold mb-3">Prizes</h2>
        <div id="prizeGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- prizes injected here -->
        </div>

        <div class="mt-6 bg-white/5 p-3 rounded-md">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Activity Log</h3>
            <button id="clearLogBtn" class="px-2 py-1 text-xs rounded bg-gray-600 hover:bg-gray-700 transition-colors">Clear</button>
          </div>
          <pre id="log" class="text-xs max-h-48 overflow-auto"></pre>
        </div>
      </section>
    </main>
  </div>

  <audio id="clickSound" src="/media/click.mp3"></audio>

  <script src="/shared.js"></script>
  <script>
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const deviceIdInput = document.getElementById('deviceId');
    const deviceSecretInput = document.getElementById('deviceSecret');
    const loginError = document.getElementById('loginError');
    const controls = document.getElementById('controls');
    const startBtn = document.getElementById('startBtn');
    const finishBtn = document.getElementById('finishBtn');
    const showPricingBtn = document.getElementById('showPricingBtn');
    const hidePricingBtn = document.getElementById('hidePricingBtn');
    const prizeGrid = document.getElementById('prizeGrid');
    const logEl = document.getElementById('log');
    const clearLogBtn = document.getElementById('clearLogBtn');
    const statusBadge = document.getElementById('statusBadge');
    const clickSound = document.getElementById('clickSound');

    // Session info elements
    const deviceName = document.getElementById('deviceName');
    const gameName = document.getElementById('gameName');
    const connectionTime = document.getElementById('connectionTime');

    let socket, device, currentRound = null;
    let loginTime = null;

    function addLog(msg){
      const s = new Date().toLocaleTimeString() + " - " + msg + "\n";
      logEl.textContent = s + logEl.textContent;
    }

    function updateSessionInfo() {
      if (device) {
        deviceName.textContent = device.deviceId || '-';
        gameName.textContent = device.gameName || '-';
        connectionTime.textContent = loginTime ? loginTime.toLocaleTimeString() : '-';
      }
    }

    function logout() {
      // Disconnect socket if connected
      if (socket) {
        socket.disconnect();
        socket = null;
      }

      // Clear stored credentials
      localStorage.removeItem('token');
      localStorage.removeItem('device');

      // Reset UI state
      device = null;
      currentRound = null;
      loginTime = null;

      // Reset form and show login card
      statusBadge.textContent = 'Not logged';
      statusBadge.className = 'px-4 py-2 rounded-md bg-gray-800 text-sm';
      document.getElementById('loginCard').style.display = 'block';
      controls.classList.add('hidden');
      logoutBtn.classList.add('hidden');

      // Clear form inputs
      deviceIdInput.value = '';
      deviceSecretInput.value = '';
      loginError.textContent = '';

      // Clear session info
      deviceName.textContent = '-';
      gameName.textContent = '-';
      connectionTime.textContent = '-';

      // Clear prize grid
      prizeGrid.innerHTML = '';

      // Add logout log entry
      addLog('Logged out');

      // Focus on device ID input
      setTimeout(() => deviceIdInput.focus(), 100);
    }

    loginBtn.onclick = async () => {
      loginError.textContent = "";
      try {
        const data = await deviceLogin(deviceIdInput.value.trim(), deviceSecretInput.value.trim());
        device = data.device;
        loginTime = new Date();
        
        statusBadge.textContent = device.gameName + " · Operator";
        statusBadge.className = 'px-4 py-2 rounded-md bg-emerald-600 text-sm';
        
        document.getElementById('loginCard').style.display = 'none';
        controls.classList.remove('hidden');
        logoutBtn.classList.remove('hidden');
        
        updateSessionInfo();
        initSocket();
        loadPrizes();
        addLog('Logged in as ' + device.deviceId);
      } catch (e) {
        loginError.textContent = e.message;
      }
    };

    logoutBtn.onclick = () => {
      if (confirm('Are you sure you want to logout?')) {
        logout();
      }
    };

    clearLogBtn.onclick = () => {
      logEl.textContent = '';
      addLog('Log cleared');
    };

    async function loadPrizes(){
      const res = await fetch(`/api/games/${device.gameId}/prizes`, {
        headers: { Authorization: 'Bearer ' + getToken() }
      });
      const prizes = await res.json();
      prizeGrid.innerHTML = '';
      for(const p of prizes){
        const card = document.createElement('div');
        card.className = 'bg-white/6 p-3 rounded-lg shadow hover:scale-105 transition transform';
        card.innerHTML = `
          <img src="${p.media || '/media/sample1.jpg'}" class="w-full h-36 object-cover rounded-md mb-2" />
          <h4 class="font-bold">${p.title}</h4>
          <p class="text-sm opacity-70">${p.description || ''}</p>
          <div class="mt-3 flex gap-2">
            <button class="announceBtn flex-1 py-2 rounded-md bg-indigo-500 hover:bg-indigo-600 font-semibold">Announce</button>
          </div>
        `;
        prizeGrid.appendChild(card);
        card.querySelector('.announceBtn').onclick = async () => {
          clickSound.play().catch(()=>{});
          await announcePrize(p.id);
        };
      }
    }

    function initSocket(){
      socket = io({ auth: { token: getToken() } });
      socket.on('connect', () => {
        addLog('Realtime connected');
        statusBadge.textContent = device.gameName + " · Connected";
        statusBadge.className = 'px-4 py-2 rounded-md bg-green-600 text-sm';
      });
      
      socket.on('disconnect', () => {
        addLog('Realtime disconnected');
        statusBadge.textContent = device.gameName + " · Disconnected";
        statusBadge.className = 'px-4 py-2 rounded-md bg-red-600 text-sm';
      });

      socket.on('connect_error', (error) => {
        addLog('Connection error: ' + error.message);
        statusBadge.textContent = device.gameName + " · Error";
        statusBadge.className = 'px-4 py-2 rounded-md bg-red-600 text-sm';
      });

      socket.on('game_started', (payload) => {
        addLog('Game started (roundId='+payload.roundId+')');
        currentRound = payload.roundId;
        finishBtn.disabled = false;
        gsap.fromTo('#statusBadge', {backgroundColor:'#f59e0b'}, {backgroundColor:'#10b981', duration:0.6});
      });
      
      socket.on('prize_announced', (payload) => {
        addLog('Prize announced: ' + payload.prize.title);
        currentRound = payload.roundId;
        finishBtn.disabled = false;
      });
      
      socket.on('round_finished', (payload) => {
        addLog('Round finished');
        currentRound = null;
        finishBtn.disabled = true;
      });
    }

    startBtn.onclick = () => {
      socket.emit('start_round');
      addLog('Start pressed');
      startBtn.classList.add('animate-pulse');
      setTimeout(()=> startBtn.classList.remove('animate-pulse'), 1200);
    };

    async function announcePrize(prizeId){
      if(!currentRound){
        // ensure a round exists
        socket.emit('start_round');
        const roundId = await new Promise((resolve) => {
          const onStarted = (p) => { if(p.roundId){ resolve(p.roundId); socket.off('game_started', onStarted); } };
          socket.on('game_started', onStarted);
          setTimeout(()=> { resolve(null); socket.off('game_started', onStarted); }, 1200);
        });
        currentRound = roundId;
      }
      socket.emit('announce_prize', { roundId: currentRound, prizeId });
      addLog('Announcing prize id '+prizeId);
    }

    finishBtn.onclick = () => {
      if(!currentRound) return;
      socket.emit('finish_round', { roundId: currentRound });
      addLog('Finish pressed');
      currentRound = null;
      finishBtn.disabled = true;
    }

    // Media control buttons
    showPricingBtn.onclick = () => {
      socket.emit('show_pricing_sheet');
      addLog('Show pricing sheet requested');
      clickSound.play().catch(()=>{});
    };

    hidePricingBtn.onclick = () => {
      socket.emit('hide_pricing_sheet');
      addLog('Hide pricing sheet requested');
      clickSound.play().catch(()=>{});
    };

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (device && e.ctrlKey) {
        switch(e.key) {
          case 's':
            e.preventDefault();
            startBtn.click();
            break;
          case 'f':
            e.preventDefault();
            finishBtn.click();
            break;
          case 'p':
            e.preventDefault();
            showPricingBtn.click();
            break;
          case 'h':
            e.preventDefault();
            hidePricingBtn.click();
            break;
          case 'l':
            e.preventDefault();
            if (confirm('Logout? (Ctrl+L)')) logout();
            break;
        }
      }
    });

    // Add keyboard support for login
    [deviceIdInput, deviceSecretInput].forEach(input => {
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          loginBtn.click();
        }
      });
    });

    // auto-login if token exists (useful after quick-login)
    (function autoLogin(){
      const t = localStorage.getItem('token'), d = localStorage.getItem('device');
      if(t && d){
        try{
          const dev = JSON.parse(d);
          if(dev.role==='operator'){
            device = dev;
            loginTime = new Date(); // Approximate login time for auto-login
            
            statusBadge.textContent = device.gameName + ' · Operator';
            statusBadge.className = 'px-4 py-2 rounded-md bg-emerald-600 text-sm';
            
            document.getElementById('loginCard').style.display='none';
            controls.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            updateSessionInfo();
            initSocket();
            loadPrizes();
            addLog('Auto-logged in as '+device.deviceId);
          }
        }catch(e){}
      }
    })();
  </script>
</body>
</html>